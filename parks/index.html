<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/assets/css/tailwind.css" />
    <title>Parks.pt</title>
    <script src="//unpkg.com/alpinejs" defer></script>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
    <style>
      [x-cloak] {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <nav class="flex flex-row pb-2 mt-2 mb-2 border-gray-100 border-b-2">
  <div class="pl-2 flex-grow text-lg font-bold"><a href="/">Parks.pt</a></div>
</nav>

    <div
      class="container mx-auto"
      x-data="parks"
      x-init="getData('playground')"
      x-effect="updateMapMarkers(filteredParks())"
    >
      <div class="w-full h-16 p-2 flex" x-cloak>
        <div class="dropdown">
          <div
            tabindex="0"
            role="button"
            class="btn btn-outline m-1 btn-sm rounded-md font-bold h-10 border-gray-400"
          >
            <span x-text="getSelectedTypeDisplayName()"></span>
            <img src="/assets/images/svg/down-arrow.svg" />
          </div>
          <div
            tabindex="0"
            class="form-control dropdown-content z-[1200] menu p-2 shadow bg-base-100 rounded-box w-52"
          >
            
            <label class="label cursor-pointer">
              <span class="label-text">Playgrounds</span>
              <input
                type="radio"
                class="radio"
                value="playground"
                x-model="type"
              />
            </label>
            
            <label class="label cursor-pointer">
              <span class="label-text">Dog Parks</span>
              <input
                type="radio"
                class="radio"
                value="animal-park"
                x-model="type"
              />
            </label>
            
            <label class="label cursor-pointer">
              <span class="label-text">Exercise Parks</span>
              <input
                type="radio"
                class="radio"
                value="exercise-park"
                x-model="type"
              />
            </label>
            
            <label class="label cursor-pointer">
              <span class="label-text">Skate Parks</span>
              <input
                type="radio"
                class="radio"
                value="skate-park"
                x-model="type"
              />
            </label>
            
            <label class="label cursor-pointer">
              <span class="label-text">Sport Parks</span>
              <input
                type="radio"
                class="radio"
                value="sport-park"
                x-model="type"
              />
            </label>
            
            <label class="label cursor-pointer">
              <span class="label-text">Nature Parks</span>
              <input
                type="radio"
                class="radio"
                value="nature-park"
                x-model="type"
              />
            </label>
            
          </div>
        </div>
        <div class="dropdown">
          <div
            tabindex="0"
            role="button"
            class="btn btn-outline m-1 btn-sm rounded-md font-bold h-10 border-gray-400"
          >
            Filters
            <img src="/assets/images/svg/down-arrow.svg" />
          </div>
          <div
            tabindex="0"
            class="form-control dropdown-content z-[1200] menu p-2 shadow bg-base-100 rounded-box w-52"
          >
            
            <label class="label cursor-pointer">
              <span class="label-text">Water Fountain</span>
              <input
                type="checkbox"
                class="checkbox"
                value="water-fountain"
                x-model="filter.facilities"
              />
            </label>
            
            <label class="label cursor-pointer">
              <span class="label-text">Sitting</span>
              <input
                type="checkbox"
                class="checkbox"
                value="seating"
                x-model="filter.facilities"
              />
            </label>
            
            <label class="label cursor-pointer">
              <span class="label-text">Tree shade</span>
              <input
                type="checkbox"
                class="checkbox"
                value="tree-cover"
                x-model="filter.facilities"
              />
            </label>
            
          </div>
        </div>
        <button
          class="ml-auto btn btn-outline m-1 btn-sm rounded-md font-bold h-10 border-gray-400"
          x-show="isListView"
          x-on:click="isListView = false"
        >
          Map
        </button>
        <button
          class="ml-auto btn btn-outline m-1 btn-sm rounded-md font-bold h-10 border-gray-400"
          x-show="!isListView"
          x-on:click="isListView = true"
        >
          List
        </button>
      </div>
      <div class="flex flex-col gap-4 p-2">
        <div x-show="isLoading">Loading ...</div>
        <div x-show="isListView">
          <template
            x-for="park in filteredParks"
            x-bind:key="park.name"
            x-show="!isLoading"
          >
            <div class="w-full shrink-0 mb-4">
              <a x-bind:href="park.url">
                <img
                  class="object-cover rounded-lg w-full h-72 mb-2"
                  x-bind:src="'/assets/images' + park.url + '01.jpg'"
                />
                <div class="font-bold text-sm" x-text="park.name"></div>
                <div
                  class="text-sm"
                  x-text="`${park.location_street_address}, ${park.location_city}`"
                ></div>
              </a>
            </div>
          </template>
        </div>
        <div x-show="!isListView" class="relative">
          <div id="map" class="absolute top-0 left-0 w-screen h-screen"></div>
        </div>
      </div>
    </div>

    <script>
      const map = L.map("map").setView([41.5551463, -8.41272], 13);
      L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution:
          '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
      }).addTo(map);

      document.addEventListener("alpine:init", () => {
        Alpine.data("parks", () => ({
          data: [],
          searchData: {},
          isLoading: false,
          isListView: true,
          type: "playground",
          filter: { facilities: [], equipment: [] },
          filteredParks() {
            return this.data
              .map((park) => {
                const facilitiesMatched = this.filter.facilities.every((f) =>
                  park.facilities.includes(f)
                );
                const equipmentMatched = this.filter.equipment.every((e) =>
                  park.equipment.includes(e)
                );

                return {
                  ...park,
                  filtersMatched: facilitiesMatched && equipmentMatched,
                };
              })
              .filter((park) => park.filtersMatched);
          },
          updateMapMarkers(filteredParks) {
            for (park of this.data) {
              if (
                filteredParks.some(
                  (filteredPark) => park.url === filteredPark.url
                )
              ) {
                if (!map.hasLayer(park.mapMarker)) {
                  map.addLayer(park.mapMarker);
                }
              } else {
                if (map.hasLayer(park.mapMarker)) {
                  map.removeLayer(park.mapMarker);
                }
              }
            }
          },
          getSelectedTypeDisplayName() {
            return this.searchData.types[this.type].text_pt;
          },
          getData(type) {
            this.type = type;
            this.isLoading = true;
            fetch("/parks-all.json")
              .then((response) => response.json())
              .then((data) => {
                this.data = data.map((park) => ({
                  ...park,
                  mapMarker: new L.marker([park.latitude, park.longitude]),
                }));
                this.isLoading = false;
              });
            fetch("/search-data.json")
              .then((response) => response.json())
              .then((data) => {
                this.searchData = data;
              });
          },
        }));
      });
    </script>
  </body>
</html>
