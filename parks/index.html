<html>
  <head>
    <title>Parks.pt</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/assets/css/tailwind.css" />
    <script src="/assets/js/alpine.min.js" defer></script>
    <link rel="stylesheet" href="/assets/css/leaflet.css" />
    <script src="/assets/js/leaflet.min.js"></script>
    <style>
      [x-cloak] {
        display: none !important;
      }
    </style>
  </head>
  <body class="md:overflow-hidden">
    <div class="flex flex-col min-h-full h-full">
      <nav class="container flex flex-row mt-2 mb-2">
  <div class="flex-grow text-lg font-bold"><a href="/">Parks.pt</a></div>
</nav>

      <div
        class="container mx-auto border-gray-100 border-t-2 flex flex-col grow"
        x-data="parks"
        x-init="getData('playground')"
        x-effect="updateMapMarkers(filteredParks())"
        x-cloak
      >
        <div class="w-full h-16 px-4 py-2 md:px-0 flex">
          <div class="dropdown">
            <div
              tabindex="0"
              role="button"
              class="btn btn-outline m-1 ml-0 btn-sm rounded-md font-bold h-10 border-gray-400"
            >
              <span x-text="getSelectedTypeDisplayName()"></span>
              <img src="/assets/images/svg/down-arrow.svg" />
            </div>
            <div
              tabindex="0"
              class="form-control dropdown-content z-[1200] menu p-2 shadow bg-base-100 rounded-box w-52"
            >
              
              <label class="label cursor-pointer">
                <span class="label-text">Playgrounds</span>
                <input
                  type="radio"
                  class="radio"
                  value="playground"
                  x-model="typeTemp"
                />
              </label>
              
              <label class="label cursor-pointer">
                <span class="label-text">Dog Parks</span>
                <input
                  type="radio"
                  class="radio"
                  value="dog-park"
                  x-model="typeTemp"
                />
              </label>
              
              <label class="label cursor-pointer">
                <span class="label-text">Exercise Parks</span>
                <input
                  type="radio"
                  class="radio"
                  value="exercise-park"
                  x-model="typeTemp"
                />
              </label>
              
              <label class="label cursor-pointer">
                <span class="label-text">Skate Parks</span>
                <input
                  type="radio"
                  class="radio"
                  value="skate-park"
                  x-model="typeTemp"
                />
              </label>
              
              <label class="label cursor-pointer">
                <span class="label-text">Sport Parks</span>
                <input
                  type="radio"
                  class="radio"
                  value="sport-park"
                  x-model="typeTemp"
                />
              </label>
              
              <label class="label cursor-pointer">
                <span class="label-text">Nature Parks</span>
                <input
                  type="radio"
                  class="radio"
                  value="nature-park"
                  x-model="typeTemp"
                />
              </label>
              
              <div
                class="btn btn-sm btn-primary mt-4"
                x-on:click="updateType(); document.activeElement?.blur()"
              >
                Apply
              </div>
            </div>
          </div>
          <div class="dropdown">
            <div
              tabindex="0"
              role="button"
              class="btn btn-outline m-1 btn-sm rounded-md font-bold h-10 border-gray-400"
            >
              Filters
              <img src="/assets/images/svg/down-arrow.svg" />
            </div>
            <div
              tabindex="0"
              class="form-control dropdown-content left-1/2 -translate-x-1/2 z-[1200] menu p-2 shadow bg-base-100 rounded-box w-72"
            >
              <label class="label font-bold">Equipment</label>
              
              <label class="label cursor-pointer">
                <span class="label-text">Swings</span>
                <input
                  type="checkbox"
                  class="checkbox"
                  value="swing"
                  x-model="filterTemp.equipment"
                />
              </label>
              
              <label class="label cursor-pointer">
                <span class="label-text">Slides</span>
                <input
                  type="checkbox"
                  class="checkbox"
                  value="slide"
                  x-model="filterTemp.equipment"
                />
              </label>
              
              <label class="label cursor-pointer">
                <span class="label-text">Play House</span>
                <input
                  type="checkbox"
                  class="checkbox"
                  value="play-house"
                  x-model="filterTemp.equipment"
                />
              </label>
              

              <label class="label font-bold mt-4">Facilities</label>
              
              <label class="label cursor-pointer">
                <span class="label-text">Water Fountain</span>
                <input
                  type="checkbox"
                  class="checkbox"
                  value="water-fountain"
                  x-model="filterTemp.facilities"
                />
              </label>
              
              <label class="label cursor-pointer">
                <span class="label-text">Sitting</span>
                <input
                  type="checkbox"
                  class="checkbox"
                  value="seating"
                  x-model="filterTemp.facilities"
                />
              </label>
              
              <label class="label cursor-pointer">
                <span class="label-text">Tree shade</span>
                <input
                  type="checkbox"
                  class="checkbox"
                  value="tree-cover"
                  x-model="filterTemp.facilities"
                />
              </label>
              
              <div
                class="btn btn-sm btn-primary mt-4"
                x-on:click="updateFilter(); document.activeElement?.blur()"
              >
                Apply
              </div>
            </div>
          </div>
          <button
            class="ml-auto btn btn-outline m-1 mr-0 btn-sm rounded-md font-bold h-10 border-gray-400 md:hidden"
            x-show="view === 'list'"
            x-on:click="updateView('map'); resizeMap();"
          >
            Map
          </button>
          <button
            class="ml-auto btn btn-outline m-1 mr-0 btn-sm rounded-md font-bold h-10 border-gray-400 md:hidden"
            x-show="view === 'map'"
            x-on:click="updateView('list')"
          >
            List
          </button>
        </div>
        <div class="flex flex-col grow md:flex-row md:min-h-screen">
          <div
            x-show="window.innerWidth > 767 || view === 'map'"
            class="grow md:w-1/2"
          >
            <div id="map" class="top-0 left-0 h-full"></div>
          </div>
          <div class="px-4 md:px-0 md:pl-4 md:w-1/2 md:shadow">
            <div x-show="isLoading"></div>
            <div
              class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:max-h-screen md:overflow-y-auto md:pb-32"
              x-show="window.innerWidth > 767 || view === 'list'"
            >
              <div
                x-show="!isLoading && filteredParks().length === 0"
                class="mt-4 text-center"
              >
                <span>No parks found with your filters</span>
                <div class="mt-4 link" x-on:click="clearFilter()">
                  Clear filters
                </div>
              </div>
              <template
                class="md:w-1/3"
                x-for="park in filteredParks"
                x-bind:key="park.name"
                x-show="!isLoading"
              >
                <div class="w-full shrink-0 mb-4">
                  <a
                    x-bind:href="view && type && filter && `${park.url}${window.location.search.toString()}`"
                  >
                    <picture class="object-cover w-full">
                      <source
                        media="(max-width: 767px)"
                        x-bind:srcset="park.url + 'images/01-384-288.avif', park.url + 'images/01-384-288.webp', park.url + 'images/01-384-288.jpeg'"
                      />
                      <source
                        media="(min-width:768px)"
                        x-bind:srcset="park.url + 'images/01-768-576.avif', park.url + 'images/01-768-576.webp', park.url + 'images/01-768-576.jpeg'"
                      />
                      <img
                        class="object-cover w-full rounded-box"
                        x-bind:src="park.url + 'images/01-1344-896.jpeg'"
                      />
                    </picture>
                    <div
                      class="font-bold text-md pt-1"
                      x-text="park.name"
                    ></div>
                    <div
                      class="text-sm"
                      x-text="`${park.location_street_address}, ${park.location_city}`"
                    ></div>
                  </a>
                </div>
              </template>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>
      const map = L.map("map").setView([41.5551463, -8.41272], 13);
      L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution:
          '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
      }).addTo(map);

      document.addEventListener("alpine:init", () => {
        Alpine.data("parks", () => ({
          data: [],
          searchData: {},
          isLoading: false,
          view: "list",
          type: "playground",
          typeTemp: "playground",
          filter: { facilities: [], equipment: [] },
          filterTemp: { facilities: [], equipment: [] },
          filteredParks() {
            return this.data
              .map((park) => {
                const facilitiesMatched = this.filter.facilities.every((f) =>
                  park.facilities.includes(f)
                );
                const equipmentMatched = this.filter.equipment.every((e) =>
                  park.equipment.includes(e)
                );

                return {
                  ...park,
                  filtersMatched: facilitiesMatched && equipmentMatched,
                };
              })
              .filter((park) => park.filtersMatched);
          },
          updateFilter() {
            this.filter = { ...this.filterTemp };
            this.updateUrlParameters();
          },
          clearFilter() {
            this.filter = { facilities: [], equipment: [] };
            this.filterTemp = { facilities: [], equipment: [] };
            this.updateUrlParameters();
          },
          updateType() {
            this.type = this.typeTemp;
            this.updateUrlParameters();
          },
          updateView(view) {
            this.view = view;
            this.updateUrlParameters();
          },
          updateMapMarkers(filteredParks) {
            for (park of this.data) {
              if (
                filteredParks.some(
                  (filteredPark) => park.url === filteredPark.url
                )
              ) {
                if (!map.hasLayer(park.mapMarker)) {
                  map.addLayer(park.mapMarker);
                }
              } else {
                if (map.hasLayer(park.mapMarker)) {
                  map.removeLayer(park.mapMarker);
                }
              }
            }
          },
          resizeMap() {
            setTimeout(() => {
              map.invalidateSize();
            }, 100);
          },
          getSelectedTypeDisplayName() {
            if (!this.searchData.types) {
              return "";
            }
            return this.searchData.types[this.type].text_pt;
          },
          updateUrlParameters() {
            let url = new URL(window.location.href);
            url.searchParams.set("t", this.type);

            if (this.filter.equipment.length > 0) {
              url.searchParams.set("e", this.filter.equipment.join(","));
            }

            if (this.filter.facilities.length > 0) {
              url.searchParams.set("f", this.filter.facilities.join(","));
            }

            url.searchParams.set("v", this.view);

            history.replaceState(history.state, "", url.href);
          },
          getData(type) {
            this.type = type;
            this.isLoading = true;

            // get query params
            const searchParams = new URLSearchParams(window.location.search);

            const t = searchParams.get("t");
            const e = searchParams.get("e");
            const f = searchParams.get("f");
            const v = searchParams.get("v");

            this.type = t || type;
            this.typeTemp = t || type;
            this.filter = {
              facilities: f?.split(",") || [],
              equipment: e?.split(",") || [],
            };
            this.filterTemp = { ...this.filter };
            this.view = v || "list";

            fetch("/parks-all.json")
              .then((response) => response.json())
              .then((data) => {
                this.data = data.map((park) => ({
                  ...park,
                  mapMarker: new L.marker([park.latitude, park.longitude]).on(
                    "click",
                    () =>
                      (window.location.href = `${
                        park.url
                      }${window.location.search.toString()}`)
                  ),
                }));
                this.isLoading = false;
              });
            fetch("/search-data.json")
              .then((response) => response.json())
              .then((data) => {
                this.searchData = data;
              });
          },
        }));
      });

      document.addEventListener("alpine:initialized", () => {
        setTimeout(() => {
          map.invalidateSize();
        }, 100);
      });
    </script>
  </body>
</html>
